{% extends 'user_dashboard/starter.html' %}
{% load static %}

{% block title %}Available Products{% endblock title %}

{% block content %}
<head>
  <link rel="stylesheet" href="{% static '/user_dashboard/css/vendor_products.css '%}">
</head>
<section>
  <div class="container py-0">
      <div class="row">
        <h3 class="mb-3">Vendor Products</h3>
          {% for prod,m_status,p_rating in zipped_value %}
          <div class="col-md-4 col-lg-4 col-xl-4 mb-4">
            <div class="card shadow-0 border rounded-3 h-100">
              <div class="card-body p-1">
                <div class="bg-image v_product_img-container">
                  <img src="{{prod.image.url}}" class="w-100 v_product_img mb-2"  />
                  <a href="#!">
        
                  </a>
                </div>
                  <div class="px-2 pt-2">
                    <div class="d-flex justify-content-between ">
                      <p class="mb-0">{{prod.name }}</p>
                    <div class=" rating-container mb-2">
                      <i class="fa fa-star"></i>
                      <p class="">{{p_rating}}</p>
                    </div>
                    </div>
                <p class="text-truncate small mb-2">
                  {{prod.description|truncatewords:20}}
                </p>
                
                <div class="d-flex ">
                  <p class="mb-1 me-1"><i class="fa fa-inr"></i>{{prod.discount_price}}</p>
                  <span class="text-secondary disc_price"><s><i class="fa fa-inr"></i>{{prod.max_price}}</s></span>
                </div>
                
                <div class="mb-2 text-muted small">
                  <span class="green_text"> • </span>
                  <span>Avalable</span>
                  <span class=""> - </span>
                  <span>{{prod.stock}}<br /></span>
                </div>
                <div class="mb-2 text-muted small">
                  <span class="green_text"> • </span>
                  <span>Category</span>
                  <span class=""> - </span>
                  <span>{{prod.category}}<br /></span>
                </div>
                <p class=" mb-0">By : {{prod.vendor.full_name}}</p>
                <p class="d-flex   check_para">
                  <label class="form-check-label">
                    <input class="form-check-input offer-discount-checkbox"
                        type="checkbox" name="offer_discount"
                        value="1" data-product-id="{{ prod.id }}" data-vendor-email="{{ prod.vendor.email }}" >
                    <small class="green_text">Exchange {{prod.green_coins_required}} green coins for discount of {{prod.discount_percentage}}%.</small>
                  </label>
      orm-c     </p>

                
                <div class="d-flex flex-column  mb-2">
                  <a href="#" class="btn btn-outline btn-sm  buy-now-button" data-product-id="{{ prod.id }}" data-vendor-email="{{ prod.vendor.email }}" type="button">
                    Buy Now
                  </a>
                  <a href="{% url 'chat:startmessages' prod.vendor.id prod.name %}" class="btn btn-outline btn-sm mt-2" type="button">
                    Send Message
                  </a>
                </div>
                  </div>
              </div>
            </div>
          </div>
          {% endfor %}
      </div>
  </div>
</section>
</div>
{% endblock content %}

{% block scripts %}
<script>
    document.querySelectorAll('.buy-now-button').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault(); // Prevent default behavior of anchor tag

            const productId = this.getAttribute('data-product-id');
            const vendorEmail = this.getAttribute('data-vendor-email');

            // Get the corresponding checkbox for this product
            const offerDiscountCheckbox = this.closest('.row').querySelector('.offer-discount-checkbox');
            const offerDiscountValue = offerDiscountCheckbox.checked ? "1" : "0";

            // Define the URL pattern in JavaScript
            const urlPattern = "{% url 'user_dashboard:checkout_vendor_products' 0 0 %}";

            // Replace placeholders in URL pattern with actual data
            const urlWithParams = urlPattern.replace('0', productId).replace('0', vendorEmail);

            // Append offer discount value as query parameter
            const urlWithDiscount = `${urlWithParams}?offer_discount=${offerDiscountValue}`;

            // Redirect to the checkout URL with checkbox value included
            window.location.href = urlWithDiscount;
        });
    });
</script>
{% endblock scripts %}
